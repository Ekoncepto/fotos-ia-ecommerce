# Requirements Traceability Matrix

## Story: 1.3.1 - Sistema de Créditos

### Coverage Summary

- Total Requirements: 4
- Fully Covered: 2 (50%)
- Partially Covered: 2 (50%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Toda nova conta de usuário criada deve receber um saldo inicial de X créditos.

**Coverage: PARTIAL**

**Given-When-Then Mappings:**

- **Unit Test**: `apps/web/app/auth/callback/route.test.ts::should allocate credits for a new user`
  - **Given**: A new user authenticates successfully via Google OAuth.
  - **When**: The auth callback route is triggered.
  - **Then**: A new entry is inserted into the `user_credits` table with an initial balance.
- **Unit Test**: `apps/web/app/auth/callback/route.test.ts::should not re-allocate credits for an existing user`
  - **Given**: An existing user with credits authenticates successfully.
  - **When**: The auth callback route is triggered.
  - **Then**: No new entry is inserted into the `user_credits` table.

**Gap**: The current implementation is not atomic. There is a race condition between checking for an existing user and inserting credits. This could lead to a user receiving credits multiple times or no credits at all if the insert operation fails after the user is created. This directly relates to the gate concern `TECH-001`.

---

#### AC2: O usuário deve conseguir ver seu saldo de créditos atual na interface.

**Coverage: FULL**

**Given-When-Then Mappings:**

- **Unit Test**: `apps/web/app/api/credits/route.test.ts::should return credit balance for an authenticated user`
  - **Given**: An authenticated user has a credit balance.
  - **When**: The user's browser makes a GET request to `/api/credits`.
  - **Then**: The API returns a JSON object with the user's credit amount.
- **Component Test**: `apps/web/components/image-generator.test.tsx::should display credits and enable button if sufficient credits`
  - **Given**: The `ImageGenerator` component is rendered.
  - **When**: The component successfully fetches the credit balance.
  - **Then**: The credit balance is displayed to the user.

---

#### AC3: A geração de um pacote de imagens deve consumir um número predefinido de créditos.

**Coverage: PARTIAL**

**Given-When-Then Mappings:**

- **Unit Test**: `apps/web/app/api/generate-image/route.test.ts::should deduct credits and return success for sufficient credits`
  - **Given**: An authenticated user has sufficient credits.
  - **When**: The user initiates an image generation by sending a POST request to `/api/generate-image`.
  - **Then**: The user's credit balance is reduced by the predefined amount.

**Gap**: The credit deduction logic is not idempotent. If a client retries a request after the server has deducted credits but before the client receives a response (e.g., due to a network error), the user could be charged multiple times for a single image generation. This relates to the gate concern `TECH-002`.

---

#### AC4: Se o usuário não tiver créditos suficientes, o botão "Gerar Fotos" deve exibir uma mensagem clara informando a situação.

**Coverage: FULL**

**Given-When-Then Mappings:**

- **Unit Test**: `apps/web/app/api/generate-image/route.test.ts::should return 403 for insufficient credits`
  - **Given**: An authenticated user has insufficient credits.
  - **When**: The user sends a POST request to `/api/generate-image`.
  - **Then**: The API returns a 403 Forbidden status with an "Insufficient credits" error.
- **Component Test**: `apps/web/components/image-generator.test.tsx::should display insufficient credits message and disable button if insufficient credits`
  - **Given**: The `ImageGenerator` component is rendered for a user with insufficient credits.
  - **When**: The credit balance is fetched.
  - **Then**: The "Gerar Fotos" button is disabled and a message indicating insufficient credits is displayed.

---

### Critical Gaps & Risks

1.  **Race Condition in Credit Allocation (High Risk - `TECH-001`)**:
    -   **Gap**: The check for an existing user and the insertion of initial credits are not performed in a single, atomic transaction.
    -   **Risk**: This can lead to inconsistent data, where a user might get credits multiple times or not at all. This is a critical flaw in the credit system's foundation.
    -   **Action**: The credit allocation logic in `apps/web/app/auth/callback/route.ts` must be refactored to use a database transaction or an atomic remote procedure call (RPC) in Supabase.

2.  **Lack of Idempotency in Credit Consumption (High Risk - `TECH-002`)**:
    -   **Gap**: The `/api/generate-image` endpoint does not have a mechanism to prevent multiple deductions for the same generation request.
    -   **Risk**: Users could lose credits unfairly due to network issues or client-side retries. This undermines user trust.
    -   **Action**: Implement an idempotency key mechanism for the image generation endpoint. The client should generate a unique key for each request, and the server should track these keys to prevent reprocessing.

3.  **Missing Security Tests (High Risk - `SEC-001`)**:
    -   **Gap**: There are no tests to verify security measures like rate limiting or to prevent unauthorized credit manipulation.
    -   **Risk**: The credit system is vulnerable to abuse and exploitation.
    -   **Action**: Add specific tests for rate limiting on credit-related API endpoints. Add tests to ensure that only authenticated and authorized users can access and modify their credit balance.

### Test Design Recommendations

Based on the gaps identified, I recommend the following new tests:

1.  **Transactional Credit Allocation Tests**:
    -   **Type**: Integration Test (or RPC test for Supabase).
    -   **Description**: Write a test that simulates concurrent requests for the same new user to ensure that credits are allocated exactly once. This will likely require creating a Supabase RPC function that handles the logic atomically and writing a test for that function.
2.  **Idempotent Credit Consumption Tests**:
    -   **Type**: Integration Test.
    -   **Description**: Write tests for the `/api/generate-image` endpoint that include an idempotency key. Verify that sending the same request multiple times with the same key results in only one credit deduction.
3.  **Security Tests**:
    -   **Type**: Integration Test.
    -   **Description**:
        -   Add tests to verify that the API endpoints have rate limiting enabled. This might require mocking the rate-limiting mechanism.
        -   Add tests to ensure that a user cannot access or modify the credits of another user.

### Risk Assessment Summary

-   **High Risk**: Requirements AC1 and AC3 have significant gaps in their test coverage that expose the system to data inconsistency, financial loss for the user, and exploitation. The high-severity issues from the gate file are directly linked to these gaps.
-   **Low Risk**: Requirements AC2 and AC4 are well-tested and pose a low risk of failure.

This traceability matrix and the identified gaps should be used to guide the development of new tests and the refactoring of the existing code to address the `CONCERNS` in the gate file.
