# Risk Profile: Story 1.5

Date: 2025-09-10
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 2
- Risk Score: 56/100

## High Risks Requiring Attention

### 1. [SEC-001]: Authorization bypass via incorrect public route configuration
**Score: 6 (High)**
**Probability**: Medium — Regex/matcher mistakes are common.
**Impact**: High — Protected pages exposed to unauthenticated users.
**Mitigation**:
- Use a deny-by-default approach; explicitly allowlist public routes (`/login`, `/auth/:path*`).
- Exclude static routes (`/_next`, files with extensions, `favicon.ico`, `robots.txt`, `sitemap.xml`).
- Add unit/E2E tests to verify protected vs public behavior.
**Testing Focus**: Attempt access to known protected pages as an unauthenticated user; ensure redirect to `/login`.

### 2. [TECH-001]: Redirect loops due to incorrect auth-state checks
**Score: 6 (High)**
**Probability**: Medium — Edge/middleware auth can be subtle.
**Impact**: High — Users locked out or stuck in loops.
**Mitigation**:
- Refresh Supabase session in middleware before auth checks using `@supabase/ssr` cookie adapters.
- Do not redirect when already on `/login` or `/auth/:path*`.
- Add loop guards and comprehensive unit/E2E cases.
**Testing Focus**: Authenticated user hitting `/login` should be redirected to `/`; unauthenticated user hitting protected page should see a single redirect to `/login`.

## Risk Distribution

### By Category
- Security: 2 risks (1 high)
- Technical: 3 risks (1 high)
- Performance: 1 risk (0 high)
- Data: 0 risks
- Business: 1 risk (0 high)
- Operational: 1 risk (0 high)

### By Component
- Frontend (App Router): 2 risks
- Backend: 0 risks
- Database: 0 risks
- Infrastructure/Edge (Middleware, Netlify): 6 risks

## Detailed Risk Register

| Risk ID  | Description                                                                 | Probability | Impact     | Score | Priority | Mitigation Actions |
| -------- | --------------------------------------------------------------------------- | ----------- | ---------- | ----- | -------- | ------------------ |
| SEC-001  | Authorization bypass via overly permissive matcher/public routes.           | Medium (2)  | High (3)   | 6     | High     | Explicit allowlist for public routes; exclude static paths; unit/E2E tests. |
| TECH-001 | Redirect loops from incorrect auth-state handling and route checks.         | Medium (2)  | High (3)   | 6     | High     | Refresh session before checks; avoid redirects on `/login` and `/auth/:path*`; loop guards. |
| TECH-002 | Supabase SSR session not refreshed in middleware (false negatives).         | Medium (2)  | Medium (2) | 4     | Medium   | Implement `createServerClient` with proper cookie adapters and pass `NextResponse` to persist cookies. |
| OPS-001  | Missing env vars in environments causing runtime failures.                  | Medium (2)  | Medium (2) | 4     | Medium   | Validate `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` in CI and deploy pipelines. |
| BUS-001  | User drop-off due to broken redirects impacting onboarding.                 | Medium (2)  | Medium (2) | 4     | Medium   | Thorough pre-release testing; feature flags; graceful fallback messaging. |
| PERF-001 | Added latency from middleware on all matched routes.                        | High (3)    | Low (1)    | 3     | Low      | Keep logic minimal; narrow matcher; monitor TTFB. |
| SEC-002  | Open redirect risks if redirect URLs are derived from user input.           | Low (1)     | High (3)   | 3     | Low      | Always build redirects with `new URL('/path', request.url)`; reject external targets. |
| TECH-003 | Rate limiter interference with auth flows (unexpected 429s).                | Low (1)     | Medium (2) | 2     | Low      | Scope limiter to `/api/auth/:path*`; add tests to ensure callback unaffected. |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Verify protected routes redirect unauthenticated users to `/login` (no access).
- Verify authenticated users on `/login` are redirected to `/` (no loop).
- Validate matcher behavior for static and special routes; ensure `/auth/:path*` is always accessible.

### Priority 2: Medium Risk Tests
- Unit test session refresh in middleware with mocked `@supabase/ssr` adapter.
- CI check for presence/format of required env vars.
- UX/E2E tests to ensure a clean onboarding path without unexpected redirects.

### Priority 3: Low Risk Tests
- Measure TTFB before/after middleware for key pages.
- Negative tests for open-redirect attempts with crafted query params.

## Risk Acceptance Criteria

### Must Fix Before Production
- SEC-001, TECH-001

### Can Deploy with Mitigation
- TECH-002, OPS-001, BUS-001 (with monitoring and fallback)

### Accepted Risks
- PERF-001, SEC-002, TECH-003 (monitor; low impact/likelihood)

## Monitoring Requirements

- Track 302/307 redirect rates by route and auth status.
- Alert on spikes in 401/429 on auth and protected routes.
- Synthetic checks for login→callback→home flow.

