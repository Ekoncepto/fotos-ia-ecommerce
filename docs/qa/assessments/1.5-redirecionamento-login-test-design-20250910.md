# Test Design: Story 1.5

Date: 2025-09-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 14
- Unit tests: 8 (57%)
- Integration tests: 3 (21%)
- E2E tests: 3 (21%)
- Priority distribution: P0: 6, P1: 6, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Usuário não autenticado em rota protegida → redirect `/login`

#### Scenarios

| ID              | Level | Priority | Test                                                                   | Justification |
| ----------------|-------|----------|------------------------------------------------------------------------|---------------|
| 1.5-UNIT-001    | Unit  | P0       | Unauth request to `/` returns 307 redirect to `/login`                 | Core logic in middleware |
| 1.5-UNIT-002    | Unit  | P0       | Unauth request to `/dashboard` returns 307 to `/login`                 | Core logic in middleware |
| 1.5-E2E-001     | E2E   | P1       | Browser navigation unauthenticated to `/` lands on `/login`            | Critical user journey |

Mitigates risks: [SEC-001, TECH-001]

### AC2: Usuário autenticado em `/login` → redirect `/`

#### Scenarios

| ID              | Level | Priority | Test                                                                   | Justification |
| ----------------|-------|----------|------------------------------------------------------------------------|---------------|
| 1.5-UNIT-003    | Unit  | P0       | Authenticated request to `/login` returns 307 redirect to `/`          | Prevent loop/back navigation issues |
| 1.5-E2E-002     | E2E   | P1       | With valid session cookie, visit `/login` → redirected to `/`          | UX-critical behavior |

Mitigates risks: [TECH-001]

### AC3: `/login` e `/auth/callback` acessíveis sem bloqueio

#### Scenarios

| ID              | Level | Priority | Test                                                                   | Justification |
| ----------------|-------|----------|------------------------------------------------------------------------|---------------|
| 1.5-UNIT-004    | Unit  | P0       | Unauth request to `/login` → `NextResponse.next()` (no redirect)       | Public route allowlist |
| 1.5-UNIT-005    | Unit  | P0       | Unauth request to `/auth/callback` passes                              | OAuth flow continuity |
| 1.5-E2E-003     | E2E   | P1       | End-to-end login: `/login` → Google stub → `/auth/callback` → `/`      | Happy path onboarding |

Mitigates risks: [SEC-001, TECH-003]

### AC4: Middleware atualiza sessão Supabase antes de checar auth

#### Scenarios

| ID              | Level       | Priority | Test                                                               | Justification |
| ----------------|-------------|----------|--------------------------------------------------------------------|---------------|
| 1.5-INT-001     | Integration | P0       | Session refresh triggers cookie set via `@supabase/ssr` adapter    | Multi-component behavior (cookies + client) |
| 1.5-UNIT-006    | Unit        | P1       | Missing/invalid cookies → user null; valid cookies → user object   | Logic branch validation |

Mitigates risks: [TECH-002]

### AC5: Rate limiting mantido em `/api/auth/:path*`

#### Scenarios

| ID              | Level       | Priority | Test                                                                 | Justification |
| ----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 1.5-UNIT-007    | Unit        | P1       | More than MAX requests/min to `/api/auth/foo` yields 429             | Regression for existing limiter |
| 1.5-INT-002     | Integration | P2       | Limiter storage/windowing behaves across multiple IPs                | Behavior across inputs |

Mitigates risks: [TECH-003]

### AC6: `config.matcher` evita estáticos e cobre `/login` e `/auth/:path*`

#### Scenarios

| ID              | Level       | Priority | Test                                                                    | Justification |
| ----------------|-------------|----------|-------------------------------------------------------------------------|---------------|
| 1.5-UNIT-008    | Unit        | P0       | Request to `/_next/static/a.js` bypasses auth checks                    | Avoid perf hit and false redirects |
| 1.5-INT-003     | Integration | P1       | Requests to files with extension (e.g., `/file.png`) bypass checks      | Matcher correctness across patterns |

Mitigates risks: [SEC-001, PERF-001]

### Cross-cutting Security and UX

#### Scenarios

| ID              | Level | Priority | Test                                                                 | Justification |
| ----------------|-------|----------|----------------------------------------------------------------------|---------------|
| 1.5-UNIT-009    | Unit  | P0       | Redirect targets built with `new URL('/path', request.url)` only     | Prevent open redirects |
| 1.5-E2E-004     | E2E   | P1       | Attempt external redirect via query param fails (stays in app)       | Security UX hardening |

Mitigates risks: [SEC-002]

## Risk Coverage

- SEC-001 (High): 1.5-UNIT-001/002/004/008, 1.5-E2E-001
- TECH-001 (High): 1.5-UNIT-003, 1.5-E2E-002
- TECH-002 (Medium): 1.5-INT-001, 1.5-UNIT-006
- OPS-001 (Medium): Covered indirectly by CI env validation recommendation (see Notes)
- BUS-001 (Medium): 1.5-E2E-003
- PERF-001 (Low): 1.5-UNIT-008, 1.5-INT-003
- SEC-002 (Low): 1.5-UNIT-009, 1.5-E2E-004
- TECH-003 (Low): 1.5-UNIT-007, 1.5-INT-002

## Recommended Execution Order

1. P0 Unit tests: 1.5-UNIT-001/002/003/004/008/009
2. P0 Integration: 1.5-INT-001
3. P1 E2E: 1.5-E2E-001/002/003
4. P1/P2 remaining: 1.5-UNIT-005/006/007, 1.5-INT-002/003, 1.5-E2E-004

## Notes & Implementation Hints

- Unit tests (Vitest):
  - Mock `apps/web/lib/supabase/middleware` helper to return `{ user: null }` vs `{ user: { id: 'x' } }`.
  - Mock `next/server` `NextRequest`/`NextResponse` and assert `.redirect` vs `.next()`.
- Integration tests:
  - Provide minimal cookie adapter stubs to validate that `createServerClient` sets cookies on `NextResponse` during session refresh.
  - Validate rate limiter isolation by IP (simulate multiple IP headers).
- E2E (Playwright):
  - Unauthenticated flows should land on `/login` on direct navigation to `/`.
  - For authenticated scenarios, set Supabase session cookies via a test helper or a seeded session to avoid real OAuth.
  - Ensure `/auth/callback` route remains reachable and not rate-limited.
- CI/Env validation (Ops):
  - Add a pre-run check to ensure `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` are set.

## Test Artifact Pointers

- Unit: `apps/web/middleware.test.ts`
- E2E: `apps/web/tests/auth-redirect.spec.ts`

## Gate Block (pasteable)

test_design:
  scenarios_total: 14
  by_level:
    unit: 8
    integration: 3
    e2e: 3
  by_priority:
    p0: 6
    p1: 6
    p2: 2
  coverage_gaps: []

## Trace References

Test design matrix: docs/qa/assessments/1.5-redirecionamento-login-test-design-20250910.md
P0 tests identified: 7

