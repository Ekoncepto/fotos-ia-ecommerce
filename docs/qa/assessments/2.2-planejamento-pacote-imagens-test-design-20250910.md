# Test Design: Story 2.2

Date: 2025-09-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 16
- Unit tests: 6 (38%)
- Integration tests: 6 (38%)
- E2E tests: 4 (25%)
- Priority distribution: P0: 7, P1: 7, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: IA cria um “plano de geração” a partir do produto

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.2-UNIT-001    | Unit        | P0       | Validação de schema do plano (tipos permitidos, campos obrigatórios) | Core contract |
| 2.2-UNIT-002    | Unit        | P1       | Prompt template versionado gera placeholders corretos                 | Stability |
| 2.2-INT-001     | Integration | P0       | Golden set: produtos representativos produzem planos esperados       | Quality guard |

### AC2: Plano define tipos de imagem (principal, lifestyle, detalhe)

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.2-UNIT-003    | Unit        | P0       | Normalização de tipos e mapeamento para enum suportado               | Prevent drift |
| 2.2-INT-002     | Integration | P1       | Rejeição de tipos não suportados e fallback                          | Robustness |

### AC3: IA de geração executa o plano

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.2-INT-003     | Integration | P0       | Mapeamento plano→parâmetros do gerador; execução com sucesso         | Contract |
| 2.2-INT-004     | Integration | P0       | Fallback para fluxo baseline quando plano inválido/falha             | Resilience |
| 2.2-E2E-001     | E2E         | P1       | Usuário recebe pacote conforme plano (tipos corretos)                | UX outcome |

### AC4: Fluxo manual continua funcionando

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.2-E2E-002     | E2E         | P0       | Baseline manual gera 2 imagens padrão inalteradas                    | Regression guard |
| 2.2-INT-005     | Integration | P1       | Feature flag desliga planner e preserva baseline                     | Safety switch |

### AC5: Integração com upload/pacotes inalterada

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.2-INT-006     | Integration | P1       | Eventos/contratos entre upload→planner→gerador mantidos              | Stability |
| 2.2-E2E-003     | E2E         | P1       | Pipeline completo com planner habilitado                              | End-to-end |

### Cross-cutting: Latência e Custo

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.2-UNIT-004    | Unit        | P2       | Orçamento de tokens por template (smoke)                              | Cost hygiene |
| 2.2-INT-007     | Integration | P1       | Latência adicional do planner dentro do budget                        | Perf guard |
| 2.2-E2E-004     | E2E         | P1       | Tempo total planner+geração aceitável                                 | Perf guard |

## Risk Coverage

- BUS-001 (High): 2.2-INT-001, 2.2-E2E-001
- TECH-001 (High): 2.2-INT-003/004/006
- PERF-001/COST-001: 2.2-INT-007, 2.2-E2E-004, 2.2-UNIT-004
- TECH-002 drift: 2.2-UNIT-002/003

## Recommended Execution Order

1. P0 unit/integration: 2.2-UNIT-001/003, 2.2-INT-001/003/004
2. P0 E2E: 2.2-E2E-002
3. P1 integration/E2E: 2.2-INT-002/005/006/007, 2.2-E2E-001/003
4. P2 unit: 2.2-UNIT-004

## Notes & Implementation Hints

- Definir schema estrito do plano (enum tipos, prompts, constraints) e validar antes de executar.
- Manter templates versionados com testes de regressão.
- Implementar fallback automático para baseline em qualquer invalidez.

## Test Artifact Pointers

- Unit: apps/planner/__tests__/plan-schema.test.ts
- Integration: apps/planner/tests/plan-to-generator.integration.test.ts
- E2E: apps/web/tests/planner-flow.spec.ts

## Gate Block (pasteable)

test_design:
  scenarios_total: 16
  by_level:
    unit: 6
    integration: 6
    e2e: 4
  by_priority:
    p0: 7
    p1: 7
    p2: 2
  coverage_gaps: []

## Trace References

Story: docs/stories/2.2.planejamento-pacote-imagens.md
Risk profile: docs/qa/assessments/2.2-planejamento-pacote-imagens-risk-20250910.md

