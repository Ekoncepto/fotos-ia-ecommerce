# Test Design: Story 2.3

Date: 2025-09-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 7 (39%)
- Integration tests: 7 (39%)
- E2E tests: 4 (22%)
- Priority distribution: P0: 8, P1: 8, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Campo de texto “Solicitar Alterações” por imagem

| ID              | Level | Priority | Test                                                                 | Justification |
|-----------------|-------|----------|----------------------------------------------------------------------|---------------|
| 2.3-UNIT-001    | Unit  | P0       | Render do campo e botões de sugestões por imagem                     | Core UI |
| 2.3-UNIT-002    | Unit  | P1       | A11y: foco/labels corretos, ações por teclado                        | Accessibility |
| 2.3-E2E-001     | E2E   | P0       | Usuário envia pedido de alteração e recebe nova versão               | UX-critical |

### AC2: Gerenciar contexto da conversa (pedidos sequenciais)

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.3-INT-001     | Integration | P0       | Estado de conversa preserva histórico e contexto entre refinamentos  | Core behavior |
| 2.3-UNIT-003    | Unit        | P1       | Sumarização/truncamento de contexto quando necessário                 | Stability |
| 2.3-INT-002     | Integration | P1       | Conciliação ao recarregar página (persistência)                       | Robustness |

### AC3: Limite de refinamentos gratuitos por pacote

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.3-INT-003     | Integration | P0       | Contabilização de créditos (incremento/decremento) correta            | Billing correctness |
| 2.3-INT-004     | Integration | P0       | Bloqueio quando limite excedido; mensagens claras                     | User clarity |
| 2.3-E2E-002     | E2E         | P1       | Fluxo com 0→1→N refinamentos mostrando contagem                       | UX transparency |

### AC4: Exibição/download inalterados

| ID              | Level | Priority | Test                                                                 | Justification |
|-----------------|-------|----------|----------------------------------------------------------------------|---------------|
| 2.3-E2E-003     | E2E   | P0       | Download e exibição das imagens existentes continuam funcionando      | Regression guard |
| 2.3-UNIT-004    | Unit  | P1       | Snapshot visual da galeria não altera botões existentes               | Visual regression |

### AC5: Sessão sem regressões

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.3-INT-005     | Integration | P1       | Reuso do middleware de sessão; rotas protegidas                       | Stability |

### Segurança e Robustez

| ID              | Level       | Priority | Test                                                                 | Justification |
|-----------------|-------------|----------|----------------------------------------------------------------------|---------------|
| 2.3-UNIT-005    | Unit        | P0       | Filtro/política de conteúdo e validação de schema do output           | Safety |
| 2.3-UNIT-006    | Unit        | P0       | Sanitização/escape ao render de texto do usuário                      | XSS prevention |
| 2.3-INT-006     | Integration | P1       | Rate limit/quotas por usuário                                         | Abuse prevention |
| 2.3-INT-007     | Integration | P1       | Concorrência: dois pedidos simultâneos reconciliam estado             | Consistency |
| 2.3-E2E-004     | E2E         | P1       | Injeção adversária é recusada com mensagem adequada                   | Security UX |
| 2.3-UNIT-007    | Unit        | P2       | Observabilidade: logs/trace com IDs correlacionados                   | Operability |

## Risk Coverage

- SEC-001 (High): 2.3-UNIT-005/006, 2.3-E2E-004
- TECH-001 (High): 2.3-INT-001/003/004/007
- XSS (SEC-002): 2.3-UNIT-006
- Perf/custo: 2.3-UNIT-003

## Recommended Execution Order

1. P0 core/security: 2.3-UNIT-001/005/006, 2.3-INT-001/003/004, 2.3-E2E-001/003
2. P1 robustness: 2.3-UNIT-002/004, 2.3-INT-002/005/006/007, 2.3-E2E-002/004
3. P2 ops: 2.3-UNIT-007

## Notes & Implementation Hints

- State único e idempotente para créditos; chaves idempotentes para requisições.
- Guardrails em camadas (prompt, validação de saída, políticas de conteúdo).
- Sanitização rigorosa ao renderizar qualquer texto do usuário.

## Test Artifact Pointers

- Unit/UI: apps/web/components/refinement/__tests__/refine-input.test.tsx
- Integration: apps/server/tests/refinement-flow.integration.test.ts
- E2E: apps/web/tests/refinement-flow.spec.ts

## Gate Block (pasteable)

test_design:
  scenarios_total: 18
  by_level:
    unit: 7
    integration: 7
    e2e: 4
  by_priority:
    p0: 8
    p1: 8
    p2: 2
  coverage_gaps: []

## Trace References

Story: docs/stories/2.3.refinamento-interativo-texto.md
Risk profile: docs/qa/assessments/2.3-refinamento-interativo-texto-risk-20250910.md

