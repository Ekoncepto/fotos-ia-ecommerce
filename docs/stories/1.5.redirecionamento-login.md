# História 1.5: Redirecionamento de Login

## Status

Draft

## Story

**Como** um usuário,
**eu quero** ser redirecionado para a página de login se não estiver autenticado,
**para que** eu possa fazer login e acessar a aplicação.

## Critérios de Aceitação

1. Usuário não autenticado que acessar qualquer rota protegida deve ser redirecionado para `/login`.
2. Usuário autenticado que acessar `/login` deve ser redirecionado para a página inicial (`/`).
3. Usuários não autenticados devem conseguir acessar `/login` e `/auth/callback` sem bloqueio.
4. O middleware deve carregar/atualizar a sessão do usuário via Supabase antes de verificar a autenticação (usar `@supabase/ssr` com cookies).
5. O middleware atual de rate limiting para `/api/auth/:path*` deve ser preservado e continuar funcional.
6. A configuração do `config.matcher` deve evitar recursos estáticos (ex.: `/_next`, arquivos com extensão) e ainda executar no `/login` e `/auth/:path*`.

## Tasks / Subtasks


- [x] Task 1: Criar helper de Supabase para uso no middleware (AC: 4)
  - [x] Subtask 1.1: Criar `apps/web/lib/supabase/middleware.ts` com um wrapper que instancia `createServerClient` do `@supabase/ssr` recebendo `request`/`response` e implementando getters/setters de cookies compatíveis com middleware.
  - [x] Subtask 1.2: Garantir que o helper documente que deve ser chamado antes da verificação de autenticação, para permitir refresh de sessão.

- [x] Task 2: Atualizar `apps/web/middleware.ts` para unificar Rate Limiting + Auth Redirect (AC: 1, 2, 3, 5, 6)
  - [x] Subtask 2.1: Preservar a lógica de rate limiting existente para `/api/auth/:path*` (mantendo cache por IP e janela de tempo).
  - [x] Subtask 2.2: Criar `NextResponse.next()` inicial com `request` headers clonados para permitir que o Supabase ajuste cookies na resposta.
  - [x] Subtask 2.3: Usar o helper de Supabase do middleware para obter `user` via `supabase.auth.getUser()`.
  - [x] Subtask 2.4: Definir rotas públicas: `'/login'`, `'/auth/:path*'`, e recursos estáticos (ignorar via matcher).
  - [x] Subtask 2.5: Redirecionar não autenticados que acessarem rotas protegidas para `/login` (usar `new URL('/login', request.url)`).
  - [x] Subtask 2.6: Redirecionar autenticados que acessarem `/login` para `/`.
  - [x] Subtask 2.7: Ajustar `export const config.matcher` para cobrir páginas do app router e evitar estáticos, por exemplo: `['/((?!_next|.*\\..*|favicon.ico|robots.txt|sitemap.xml).*)', '/login', '/auth/:path*', '/api/auth/:path*']`.

- [ ] Task 3: Variáveis de ambiente e segurança (AC: 4)
  - [ ] Subtask 3.1: Confirmar presença de `NEXT_PUBLIC_SUPABASE_URL` e `NEXT_PUBLIC_SUPABASE_ANON_KEY` em `apps/web/.env.local` e em CI/CD.
  - [ ] Subtask 3.2: Evitar open-redirects: sempre construir `Location` com `new URL(path, request.url)`.

- [x] Task 4: Testes unitários da middleware (AC: 1, 2, 3, 5)
  - [x] Subtask 4.1: Criar `apps/web/middleware.test.ts` com Vitest, mockando o helper do Supabase para simular estados autenticado/não autenticado.
  - [x] Subtask 4.2: Cenários: (a) não autenticado em `/dashboard` -> redirect 307 para `/login`; (b) autenticado em rota protegida -> `NextResponse.next`; (c) autenticado em `/login` -> redirect 307 para `/`.
  - [x] Subtask 4.3: Validar que o rate limiting segue aplicado em `/api/auth/:path*` (retorna 429 após estouro do limite).

- [ ] Task 5: Testes E2E com Playwright (AC: 1, 2, 3)
  - [x] Subtask 5.1: Adicionar `apps/web/tests/auth-redirect.spec.ts` cobrindo fluxos principais de redirecionamento.
  - [ ] Subtask 5.2: Mockar login via Supabase ou usar user seed de teste, garantindo que `/auth/callback` permanece acessível.

## Dev Notes

### Contexto de Arquitetura
- Autenticação e sessão por Supabase: [Fonte: docs/architecture/02-stack-tecnologico.md]
- Estratégia de Testes (unit e E2E): [Fonte: docs/architecture/06-estrategia-de-testes.md]
- Requisitos de Segurança (cookies, RLS, variáveis de ambiente): [Fonte: docs/architecture/07-requisitos-de-seguranca.md]
- Estrutura de Pastas (local do middleware e libs): [Fonte: docs/architecture/05-estrutura-de-pastas-do-projeto.md]

### Observações Técnicas
- Usar `@supabase/ssr` no middleware com `createServerClient` e adaptadores de cookies para ler/escrever via `NextRequest`/`NextResponse`.
- O middleware deve executar também em `/login` para redirecionar usuários já autenticados para `/`.
- Evitar interceptar recursos estáticos via `config.matcher` (ex.: `/_next`, arquivos com extensão, `favicon.ico`).
- Preservar a lógica atual de rate limiting para `/api/auth/:path*` já existente em `apps/web/middleware.ts`.
- Sempre construir URLs de redirecionamento com `new URL(path, request.url)` para manter o host correto.

### Testing
- Unit (Vitest): mock do helper Supabase de middleware e de `next/server` para validar `NextResponse.redirect`/`next`.
- E2E (Playwright): cenários de acesso autenticado/não autenticado, inclusive `/auth/callback`.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-07 | 1.0 | Rascunho inicial | Gemini |
| 2025-09-10 | 1.1 | Refino do rascunho com AC, tasks detalhadas e Dev Notes | Bob (SM) |
| 2025-09-10 | 1.2 | Implementação do middleware de auth + helper Supabase e criação de testes | James (dev) |

## Dev Agent Record

### Agent Model Used
OpenAI Codex CLI

### Debug Log References
- Criado helper `apps/web/lib/supabase/middleware.ts` com adaptadores de cookies para `@supabase/ssr`.
- Unificado rate limiting existente com redirecionamento de autenticação em `apps/web/middleware.ts`.
- Adicionados testes unitários em `apps/web/middleware.test.ts` (mocks para `next/server` e Supabase).
- Adicionado esqueleto de teste E2E `apps/web/tests/auth-redirect.spec.ts` (cobertura básica, com skip para sessão autenticada).
- Execução de testes completa falhou por testes legados não relacionados (ex.: `auth/callback` e dependência `dompurify`). Mantidos fora do escopo desta história.

### Completion Notes List
- Implementado fluxo de redirecionamento: não autenticado → `/login`; autenticado em `/login` → `/`.
- Mantido limitador de taxa para `/api/auth/:path*` e validado via teste unitário.
- Configurado `config.matcher` para evitar estáticos e ainda executar nas rotas relevantes.
- Criados testes unitários e E2E (parcial) conforme desenho de testes.
- Regressões externas detectadas, aguardando decisão sobre correções fora do escopo.

### File List
- `apps/web/lib/supabase/middleware.ts` (created)
- `apps/web/middleware.ts` (modified)
- `apps/web/middleware.test.ts` (created)
- `apps/web/tests/auth-redirect.spec.ts` (created)
