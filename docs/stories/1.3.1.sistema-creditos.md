# História 1.3.1: Sistema de Créditos

## Status
Ready for Review

## Story
**Como** um novo usuário,
**eu quero** receber um saldo inicial de créditos gratuitos ao me cadastrar,
**para que** eu possa testar a funcionalidade principal do produto.

## Critérios de Aceitação
1. Toda nova conta de usuário criada deve receber um saldo inicial de X créditos.
2. O usuário deve conseguir ver seu saldo de créditos atual na interface.
3. A geração de um pacote de imagens deve consumir um número predefinido de créditos.
4. Se o usuário não tiver créditos suficientes, o botão "Gerar Fotos" deve exibir uma mensagem clara informando a situação.

## Tasks / Subtasks
- [x] Task 1: Implement initial credit allocation on user signup.
  - [x] Subtask 1.1: Modify user registration flow to assign X credits.
  - [x] Subtask 1.2: Store initial credits in the database.
- [x] Task 2: Implement credit balance display.
  - [x] Subtask 2.1: Create API endpoint to fetch user credit balance.
  - [x] Subtask 2.2: Display credit balance in the user interface.
- [x] Task 3: Implement credit consumption for image generation.
  - [x] Subtask 3.1: Modify image generation process to deduct credits.
  - [x] Subtask 3.2: Handle insufficient credit scenarios on the backend.
- [x] Task 4: Implement UI feedback for insufficient credits.
  - [x] Subtask 4.1: Update "Gerar Fotos" button state based on credit availability.
  - [x] Subtask 4.2: Display clear message when credits are insufficient.

## Dev Notes

### Testing
List Relevant Testing Standards from Architecture the Developer needs to conform to:
- Test file location
- Test standards
- Testing frameworks and patterns to use
- Any specific testing requirements for this story

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-04 | 1.1 | Applied QA fixes for reliability and security. Refactored credit allocation to be atomic and improved client-side idempotency for credit consumption. Documented rate limiting as technical debt. | Jules (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Jules (Dev Agent)

### Debug Log References
- Encountered issues with the test runner environment (`dotenv: not found`).
- Resolved the issue by modifying `vitest.config.ts` to load the `.env.test` file directly, and updated the `test` script in `package.json` to remove the `dotenv-cli` dependency. This made the test setup more robust.
- All tests passed successfully after the fixes.

### Completion Notes List
- **Atomic Credit Allocation**: Refactored the logic in `apps/web/app/auth/callback/route.ts` to use a single atomic `insert` with `onConflict` to prevent race conditions during the initial credit allocation for new users.
- **Idempotency Mitigation**: Improved the client-side logic in `apps/web/components/image-generator.tsx` by adding an `isGenerating` state to disable the "Gerar Fotos" button during the API call. This mitigates the risk of multiple credit deductions from accidental double-clicks.
- **Rate Limiting Documentation**: Documented the need for rate limiting on credit-related APIs as technical debt in `docs/tech-debt/rate-limiting.md`. This was done because implementing a robust solution requires architectural changes that are outside the scope of this task.

### File List
- `apps/web/app/auth/callback/route.ts` (modified)
- `apps/web/app/auth/callback/route.test.ts` (modified)
- `apps/web/components/image-generator.tsx` (modified)
- `apps/web/components/image-generator.test.tsx` (modified)
- `apps/web/package.json` (modified)
- `apps/web/vitest.config.ts` (modified)
- `docs/tech-debt/rate-limiting.md` (created)
- `docs/tech-debt/idempotency.md` (created)

## QA Results

### Review Date: 2025-09-04

### Reviewed By: Quinn (Test Architect)

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.3.1-sistema-creditos.yml
